<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Budget Tracker - Portugal & France</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* PWA-like styling */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
        }
        
        /* Custom scrollbar for mobile */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Lucide React icons as simple SVG components
        const PlusCircle = ({ className = "h-5 w-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 8v8M8 12h8"></path>
            </svg>
        );
        
        const Trash2 = ({ className = "h-4 w-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );
        
        const Edit3 = ({ className = "h-4 w-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
        );
        
        const MapPin = ({ className = "h-8 w-8" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
        );
        
        const DollarSign = ({ className = "h-8 w-8" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        );
        
        const Euro = ({ className = "h-8 w-8" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M18.5 8.5C18.5 8.5 17 7 15 7a4 4 0 0 0-4 4 4 4 0 0 0 4 4c2 0 3.5-1.5 3.5-1.5"></path>
                <path d="M7 10h4m-4 4h4"></path>
            </svg>
        );
        
        const Download = ({ className = "h-4 w-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );
        
        const Upload = ({ className = "h-4 w-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17,8 12,3 7,8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const TravelBudgetTracker = () => {
            // Load data from localStorage on component mount
            const [expenses, setExpenses] = useState(() => {
                try {
                    const savedExpenses = localStorage.getItem('travelBudgetExpenses');
                    return savedExpenses ? JSON.parse(savedExpenses) : [];
                } catch (error) {
                    console.error('Error loading expenses from localStorage:', error);
                    return [];
                }
            });

            const [budgets, setBudgets] = useState(() => {
                try {
                    const savedBudgets = localStorage.getItem('travelBudgetBudgets');
                    return savedBudgets ? JSON.parse(savedBudgets) : {
                        Dan: {
                            Food: 500,
                            Transportation: 300,
                            Shopping: 400,
                            Accommodations: 800,
                            Activities: 250,
                            Miscellaneous: 150
                        },
                        Tien: {
                            Food: 500,
                            Transportation: 300,
                            Shopping: 400,
                            Accommodations: 800,
                            Activities: 250,
                            Miscellaneous: 150
                        }
                    };
                } catch (error) {
                    console.error('Error loading budgets from localStorage:', error);
                    return {
                        Dan: {
                            Food: 500,
                            Transportation: 300,
                            Shopping: 400,
                            Accommodations: 800,
                            Activities: 250,
                            Miscellaneous: 150
                        },
                        Tien: {
                            Food: 500,
                            Transportation: 300,
                            Shopping: 400,
                            Accommodations: 800,
                            Activities: 250,
                            Miscellaneous: 150
                        }
                    };
                }
            });

            const [exchangeRate, setExchangeRate] = useState(() => {
                try {
                    const savedRate = localStorage.getItem('travelBudgetExchangeRate');
                    return savedRate ? parseFloat(savedRate) : 1.17;
                } catch (error) {
                    console.error('Error loading exchange rate from localStorage:', error);
                    return 1.17;
                }
            });
            
            const [showAddForm, setShowAddForm] = useState(false);
            const [showBudgetEdit, setShowBudgetEdit] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [activePerson, setActivePerson] = useState('Dan');
            const [activeTab, setActiveTab] = useState('categories');
            const fileInputRef = useRef(null);
            
            const [formData, setFormData] = useState({
                memo: '',
                category: 'Food',
                amount: '',
                date: new Date().toISOString().slice(0, 16),
                payer: 'Dan'
            });

            const categories = ['Food', 'Transportation', 'Shopping', 'Accommodations', 'Activities', 'Miscellaneous'];

            // Save data to localStorage whenever state changes
            useEffect(() => {
                try {
                    localStorage.setItem('travelBudgetExpenses', JSON.stringify(expenses));
                } catch (error) {
                    console.error('Error saving expenses to localStorage:', error);
                }
            }, [expenses]);

            useEffect(() => {
                try {
                    localStorage.setItem('travelBudgetBudgets', JSON.stringify(budgets));
                } catch (error) {
                    console.error('Error saving budgets to localStorage:', error);
                }
            }, [budgets]);

            useEffect(() => {
                try {
                    localStorage.setItem('travelBudgetExchangeRate', exchangeRate.toString());
                } catch (error) {
                    console.error('Error saving exchange rate to localStorage:', error);
                }
            }, [exchangeRate]);

            const resetForm = () => {
                setFormData({
                    memo: '',
                    category: 'Food',
                    amount: '',
                    date: new Date().toISOString().slice(0, 16),
                    payer: 'Dan'
                });
                setShowAddForm(false);
                setEditingId(null);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.memo || !formData.amount) return;

                const amount = parseFloat(formData.amount);
                const expense = {
                    id: editingId || Date.now(),
                    memo: formData.memo,
                    category: formData.category,
                    amount: amount,
                    date: formData.date,
                    payer: formData.payer,
                    usdAmount: amount * exchangeRate,
                    danAmount: formData.payer === 'Split' ? amount / 2 : (formData.payer === 'Dan' ? amount : 0),
                    tienAmount: formData.payer === 'Split' ? amount / 2 : (formData.payer === 'Tien' ? amount : 0)
                };

                if (editingId) {
                    setExpenses(expenses.map(exp => exp.id === editingId ? expense : exp));
                } else {
                    setExpenses([...expenses, expense]);
                }
                
                resetForm();
            };

            const deleteExpense = (id) => {
                setExpenses(expenses.filter(exp => exp.id !== id));
            };

            const editExpense = (expense) => {
                setFormData({
                    memo: expense.memo,
                    category: expense.category,
                    amount: expense.amount.toString(),
                    date: expense.date,
                    payer: expense.payer
                });
                setEditingId(expense.id);
                setShowAddForm(true);
            };

            const getCategorySpending = (category, person) => {
                return expenses
                    .filter(exp => exp.category === category)
                    .reduce((sum, exp) => {
                        if (person === 'Dan') return sum + exp.danAmount;
                        if (person === 'Tien') return sum + exp.tienAmount;
                        return sum + exp.amount;
                    }, 0);
            };

            const getTotalSpending = (person) => {
                return expenses.reduce((sum, exp) => {
                    if (person === 'Dan') return sum + exp.danAmount;
                    if (person === 'Tien') return sum + exp.tienAmount;
                    return sum + exp.amount;
                }, 0);
            };

            const getTotalBudget = (person) => {
                if (person === 'Dan' || person === 'Tien') {
                    return Object.values(budgets[person]).reduce((a, b) => a + b, 0);
                }
                return Object.values(budgets.Dan).reduce((a, b) => a + b, 0) + Object.values(budgets.Tien).reduce((a, b) => a + b, 0);
            };

            const updateBudget = (person, category, value) => {
                setBudgets(prev => ({
                    ...prev,
                    [person]: {
                        ...prev[person],
                        [category]: parseFloat(value) || 0
                    }
                }));
            };

            const getProgressColor = (spent, budget) => {
                const percentage = (spent / budget) * 100;
                if (percentage >= 90) return 'bg-red-500';
                if (percentage >= 75) return 'bg-yellow-500';
                return 'bg-green-500';
            };

            // Clear all data function for testing/reset
            const clearAllData = () => {
                if (window.confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    try {
                        localStorage.removeItem('travelBudgetExpenses');
                        localStorage.removeItem('travelBudgetBudgets');
                        localStorage.removeItem('travelBudgetExchangeRate');
                        setExpenses([]);
                        setBudgets({
                            Dan: {
                                Food: 500,
                                Transportation: 300,
                                Shopping: 400,
                                Accommodations: 800,
                                Activities: 250,
                                Miscellaneous: 150
                            },
                            Tien: {
                                Food: 500,
                                Transportation: 300,
                                Shopping: 400,
                                Accommodations: 800,
                                Activities: 250,
                                Miscellaneous: 150
                            }
                        });
                        setExchangeRate(1.17);
                    } catch (error) {
                        console.error('Error clearing data:', error);
                    }
                }
            };

            // Export data to CSV
            const exportToCSV = () => {
                try {
                    const csvHeader = 'Date,Description,Category,Amount (EUR),Amount (USD),Payer,Dan Amount (EUR),Tien Amount (EUR)\n';
                    const csvRows = expenses.map(expense => {
                        const date = new Date(expense.date).toLocaleString();
                        return `"${date}","${expense.memo.replace(/"/g, '""')}","${expense.category}",${expense.amount},${expense.usdAmount.toFixed(2)},"${expense.payer}",${expense.danAmount.toFixed(2)},${expense.tienAmount.toFixed(2)}`;
                    }).join('\n');
                    
                    const csvContent = csvHeader + csvRows;
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `travel-budget-${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                    alert('Error exporting data. Please try again.');
                }
            };

            // Import data from CSV
            const importFromCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        
                        if (lines.length < 2) {
                            alert('CSV file appears to be empty or invalid.');
                            return;
                        }

                        const importedExpenses = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                if (char === '"') {
                                    if (inQuotes && line[j + 1] === '"') {
                                        current += '"';
                                        j++;
                                    } else {
                                        inQuotes = !inQuotes;
                                    }
                                } else if (char === ',' && !inQuotes) {
                                    values.push(current);
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            values.push(current);
                            
                            if (values.length >= 8) {
                                const expense = {
                                    id: Date.now() + i,
                                    date: new Date(values[0]).toISOString().slice(0, 16),
                                    memo: values[1],
                                    category: values[2],
                                    amount: parseFloat(values[3]) || 0,
                                    usdAmount: parseFloat(values[4]) || 0,
                                    payer: values[5],
                                    danAmount: parseFloat(values[6]) || 0,
                                    tienAmount: parseFloat(values[7]) || 0
                                };
                                importedExpenses.push(expense);
                            }
                        }

                        if (importedExpenses.length > 0) {
                            if (window.confirm(`Import ${importedExpenses.length} expenses? This will replace your current data.`)) {
                                setExpenses(importedExpenses);
                                alert(`Successfully imported ${importedExpenses.length} expenses!`);
                            }
                        } else {
                            alert('No valid expense data found in the CSV file.');
                        }
                    } catch (error) {
                        console.error('Error importing CSV:', error);
                        alert('Error importing CSV file. Please check the file format and try again.');
                    }
                };
                
                reader.readAsText(file);
                event.target.value = '';
            };

            const triggerFileInput = () => {
                fileInputRef.current?.click();
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <MapPin className="h-8 w-8 text-indigo-600" />
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-900">Travel Budget Tracker</h1>
                                        <p className="text-gray-600">Portugal & France Adventure - Dan & Tien</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-sm text-gray-500">Exchange Rate</div>
                                    <div className="text-lg font-semibold">1 EUR = ${exchangeRate.toFixed(2)} USD</div>
                                </div>
                            </div>
                            
                            {/* Person Toggle */}
                            <div className="mt-4 flex justify-center">
                                <div className="bg-gray-100 rounded-lg p-1 flex">
                                    {['Dan', 'Tien', 'Combined'].map(person => (
                                        <button
                                            key={person}
                                            onClick={() => setActivePerson(person)}
                                            className={`px-4 py-2 rounded-md transition-colors ${
                                                activePerson === person
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'text-gray-600 hover:text-gray-900'
                                            }`}
                                        >
                                            {person}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Add Expense Button */}
                        <div className="mb-6 flex flex-wrap gap-3 items-center justify-between">
                            <button
                                onClick={() => setShowAddForm(true)}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg flex items-center space-x-2 transition-colors"
                            >
                                <PlusCircle className="h-5 w-5" />
                                <span>Add Expense</span>
                            </button>
                            
                            <div className="flex flex-wrap gap-2">
                                {/* Export CSV Button */}
                                <button
                                    onClick={exportToCSV}
                                    className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 text-sm transition-colors"
                                >
                                    <Download className="h-4 w-4" />
                                    <span>Export CSV</span>
                                </button>
                                
                                {/* Import CSV Button */}
                                <button
                                    onClick={triggerFileInput}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 text-sm transition-colors"
                                >
                                    <Upload className="h-4 w-4" />
                                    <span>Import CSV</span>
                                </button>
                                
                                {/* Hidden file input */}
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".csv"
                                    onChange={importFromCSV}
                                    style={{ display: 'none' }}
                                />
                                
                                {/* Clear Data Button */}
                                <button
                                    onClick={clearAllData}
                                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
                                >
                                    Clear All Data
                                </button>
                            </div>
                        </div>

                        {/* Add/Edit Expense Form */}
                        {showAddForm && (
                            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                <h2 className="text-xl font-semibold mb-4">{editingId ? 'Edit Expense' : 'Add New Expense'}</h2>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                            <input
                                                type="text"
                                                value={formData.memo}
                                                onChange={(e) => setFormData({...formData, memo: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                placeholder="e.g., Dinner at local restaurant"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                            <select
                                                value={formData.category}
                                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            >
                                                {categories.map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Who's paying?</label>
                                            <select
                                                value={formData.payer}
                                                onChange={(e) => setFormData({...formData, payer: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            >
                                                <option value="Dan">Dan</option>
                                                <option value="Tien">Tien</option>
                                                <option value="Split">Split (50/50)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Amount (EUR)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={formData.amount}
                                                onChange={(e) => setFormData({...formData, amount: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                placeholder="0.00"
                                                required
                                            />
                                            {formData.amount && (
                                                <div className="text-sm text-gray-500 mt-1">
                                                    <p>≈ ${(parseFloat(formData.amount || 0) * exchangeRate).toFixed(2)} USD</p>
                                                    {formData.payer === 'Split' && (
                                                        <p>€{(parseFloat(formData.amount || 0) / 2).toFixed(2)} each</p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                                            <input
                                                type="datetime-local"
                                                value={formData.date}
                                                onChange={(e) => setFormData({...formData, date: e.target.value})}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            />
                                        </div>
                                    </div>
                                    <div className="flex space-x-3">
                                        <button
                                            type="button"
                                            onClick={handleSubmit}
                                            className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors"
                                        >
                                            {editingId ? 'Update Expense' : 'Add Expense'}
                                        </button>
                                        <button
                                            type="button"
                                            onClick={resetForm}
                                            className="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Tab Navigation */}
                        <div className="mb-6">
                            <div className="border-b border-gray-200">
                                <nav className="-mb-px flex space-x-8">
                                    <button
                                        onClick={() => setActiveTab('categories')}
                                        className={`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${
                                            activeTab === 'categories'
                                                ? 'border-indigo-500 text-indigo-600'
                                                : 'border-transparent
